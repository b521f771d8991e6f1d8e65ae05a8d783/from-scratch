name: Nix Flake ❄️
on:
 workflow_dispatch:

jobs:
 tests:
  permissions:
   contents: read
   packages: write
  strategy:
   matrix:
    os: [ubuntu-latest, macos-latest]
  runs-on: ${{ matrix.os }}
  steps:
   - uses: actions/checkout@v5
   - name: Check for nix
     id: check_nix
     run: |
      if command -v nix >/dev/null 2>&1; then
        echo "NIX_PRESENT=true" >> $GITHUB_ENV
        echo "present=true" >> $GITHUB_OUTPUT
      else
        echo "NIX_PRESENT=false" >> $GITHUB_ENV
        echo "present=false" >> $GITHUB_OUTPUT
      fi

   - name: Install Nix
     if: steps.check_nix.outputs.present == 'false'
     uses: cachix/install-nix-action@v25

   - name: Build Nix Flake
     run: |
      nix --extra-experimental-features "flakes nix-command" flake check
      nix --extra-experimental-features "flakes nix-command" build . -L --show-trace

   - name: Build and Push Docker Image
     if: runner.os == 'Linux'
     run: |
      # Build the Docker image
      nix --extra-experimental-features "flakes nix-command" build .#docker-image -L --show-trace
      nix --extra-experimental-features "flakes nix-command" run nixpkgs#skopeo -- copy -a docker-archive:./result docker://ghcr.io/${{ github.repository }}:$(git rev-parse --abbrev-ref HEAD) --dest-creds=${{ github.actor }}:${{ github.token }}
